<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mattepromenaden</title>

<style>
* { box-sizing:border-box; -webkit-touch-callout:none; }
body { margin:0; font-family:system-ui,sans-serif; background:#1e3a8a; overflow:hidden; }

/* ===== SPEL ===== */
#game{
  position:relative;
  height:60vh;
  background:linear-gradient(#60a5fa,#86efac);
  overflow:hidden;
}
#world{ position:absolute; bottom:0; left:0; width:4200px; height:100%; }
.ground{ position:absolute; bottom:0; width:4200px; height:80px; background:#22c55e; }

/* ===== MILJ√ñ ===== */
.sun{ position:absolute; top:20px; right:40px; width:80px; height:80px; background:#fde047; border-radius:50%; }
.tree{ position:absolute; bottom:80px; width:40px; height:80px; }
.tree::before{ content:""; position:absolute; bottom:0; left:14px; width:12px; height:40px; background:#92400e; }
.tree::after{ content:""; position:absolute; bottom:30px; left:-10px; width:60px; height:50px; background:#16a34a; border-radius:50%; }
.flower{ position:absolute; bottom:80px; width:16px; height:16px; background:#f472b6; border-radius:50%; }

/* ===== HINDER / PLATTFORMAR ===== */
@keyframes wiggle{0%{transform:translateX(0)}50%{transform:translateX(10px)}100%{transform:translateX(0)}}
.hedgehog{
  position:absolute; bottom:80px; width:36px; height:22px;
  background:#92400e; border-radius:12px;
  animation:wiggle 3s ease-in-out infinite;
}
.hill{
  position:absolute; bottom:80px; width:160px; height:70px;
  background:#4b5563; border-radius:80px 80px 0 0;
}

/* ===== GUBBE ===== */
#player{ position:absolute; left:45%; bottom:80px; width:40px; }
.head{
  width:24px; height:24px; background:#fde68a;
  border-radius:50%; position:relative;
  display:flex; align-items:center; justify-content:center;
}
/* keps */
.cap{
  position:absolute; top:-6px; left:-4px;
  width:32px; height:12px;
  background:#dc2626;
  border-radius:6px 6px 2px 2px;
}
.body{ width:40px; height:28px; background:#2563eb; border-radius:8px; margin-top:4px; }
.legs{ display:flex; justify-content:space-between; }
.leg{
  width:16px; height:20px; background:#1e293b;
  border-radius:6px;
}

/* ben-animation */
@keyframes walk {
  0%{transform:rotate(10deg)}
  50%{transform:rotate(-10deg)}
  100%{transform:rotate(10deg)}
}
.walking .leg{
  animation:walk .3s infinite alternate;
}

/* ===== KONTROLLER ===== */
#controls{ display:flex; justify-content:center; gap:30px; padding:12px; background:#0f172a; }
button{
  font-size:1.8rem; padding:12px 18px; border-radius:14px;
  border:none; background:#1e3a8a; color:white;
  touch-action:none;
}

/* ===== MATTE ===== */
#mathOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center; justify-content:center;
  pointer-events:auto;
}
.gridWrapper{
  background:white; padding:16px;
  border:3px solid #0f172a;
}
.grid{
  display:grid;
  grid-template-columns:56px 56px 56px;
  grid-template-rows:56px 56px 56px 56px;
}
.cell{
  border:2px solid black;
  display:flex; align-items:center; justify-content:center;
  font-size:2rem;
}
.row3{ border-bottom:6px solid black !important; }
.ones{ color:#16a34a; font-weight:700; }
.tens{ color:#2563eb; }
input{
  width:100%; height:100%;
  border:none; font-size:2rem; text-align:center;
}

/* ===== FYRVERKERI ===== */
.firework{ position:fixed; left:50%; top:40%; pointer-events:none; z-index:9999; }
.spark{
  position:absolute; width:8px; height:8px; border-radius:50%;
  animation:explode 900ms ease-out forwards;
}
@keyframes explode{
  from{transform:translate(0,0);opacity:1}
  to{transform:translate(var(--x),var(--y));opacity:0}
}
</style>
</head>

<body>

<div id="game">
  <div id="world">
    <div class="ground"></div>
    <div class="sun"></div>

    <div class="tree" style="left:400px"></div>
    <div class="tree" style="left:1600px"></div>

    <div class="hill platform" style="left:800px"></div>
    <div class="hill platform" style="left:2000px"></div>

    <div class="hedgehog obstacle" style="left:1200px"></div>
  </div>

  <div id="player">
    <div class="head">
      üôÇ<div class="cap"></div>
    </div>
    <div class="body"></div>
    <div class="legs">
      <div class="leg"></div><div class="leg"></div>
    </div>
  </div>
</div>

<div id="controls">
  <button id="leftBtn">‚¨ÖÔ∏è</button>
  <button id="jumpBtn">‚¨ÜÔ∏è</button>
  <button id="rightBtn">‚û°Ô∏è</button>
</div>

<div id="mathOverlay">
  <div class="gridWrapper">
    <div class="grid" id="grid"></div>
    <div style="text-align:center;margin-top:10px">
      <button onclick="check()">Klar</button>
      <button onclick="closeMath()">Tillbaka</button>
    </div>
  </div>
</div>

<audio id="bgMusic" src="Music.mp3" loop></audio>
<audio id="successSound" src="Correct.mp3"></audio>
<audio id="jumpSound" src="Jump.mp3"></audio>

<script>
/* ===== MATTE ===== */
const rawA4 = `39+15\n63+28\n58+34`;
const tasks = rawA4.split("\n");
let taskIndex=0, correct=0, paused=false;

/* ===== LJUD ===== */
let audioStarted=false;
function startAudio(){
  if(!audioStarted){
    bgMusic.volume=0.3;
    bgMusic.play().catch(()=>{});
    audioStarted=true;
  }
}

/* ===== SPEL ===== */
let worldX=0, vy=0, onGround=true;
let left=false, right=false;
const speed=3, gravity=0.6;

leftBtn.onpointerdown=()=>{left=true;player.classList.add("walking");startAudio();};
leftBtn.onpointerup=()=>{left=false;player.classList.remove("walking");};
rightBtn.onpointerdown=()=>{right=true;player.classList.add("walking");startAudio();};
rightBtn.onpointerup=()=>{right=false;player.classList.remove("walking");};

jumpBtn.onpointerdown=()=>{
  startAudio();
  if(onGround){
    jumpSound.play().catch(()=>{});
    vy=11; onGround=false;
  }
};

function showMath(){
  paused=true; grid.innerHTML="";
  const [a,b]=tasks[taskIndex].split("+").map(Number);
  correct=a+b;

  const aS=String(a).padStart(2,"0");
  const bS=String(b).padStart(2,"0");

  const cells=["","", "", "",aS[0],aS[1],"+",bS[0],bS[1],"i","i","i"];
  cells.forEach(v=>{
    const c=document.createElement("div"); c.className="cell";
    if(v==="i"){ const i=document.createElement("input"); c.appendChild(i);}
    else c.textContent=v;
    grid.appendChild(c);
  });

  mathOverlay.style.display="flex";
}

function check(){
  const ans=[...grid.querySelectorAll("input")].map(i=>i.value||"").join("");
  if(parseInt(ans)===correct){
    successSound.play().catch(()=>{});
    firework();
    mathOverlay.style.display="none";
    paused=false;
    taskIndex++;
  }
}
function closeMath(){ mathOverlay.style.display="none"; paused=false; }

function firework(){
  const fw=document.createElement("div"); fw.className="firework";
  document.body.appendChild(fw);
  for(let i=0;i<12;i++){
    const s=document.createElement("div"); s.className="spark";
    s.style.background=["#22c55e","#2563eb","#facc15"][i%3];
    s.style.setProperty("--x",(Math.random()*120-60)+"px");
    s.style.setProperty("--y",(Math.random()*-120)+"px");
    fw.appendChild(s);
  }
  setTimeout(()=>fw.remove(),900);
}

function loop(){
  if(!paused){
    let next=worldX;
    if(right) next-=speed;
    if(left) next+=speed;

    vy-=gravity;
    let bottom=parseFloat(player.style.bottom||80)+vy;

    onGround=false;
    document.querySelectorAll(".platform").forEach(p=>{
      const pr=player.getBoundingClientRect();
      const r=p.getBoundingClientRect();
      if(pr.bottom<=r.top+10 && pr.right>r.left && pr.left<r.right && vy<=0){
        bottom = r.top - document.getElementById("game").getBoundingClientRect().bottom;
        vy=0; onGround=true;
      }
    });

    if(bottom<=80){ bottom=80; vy=0; onGround=true; }

    world.style.left=next+"px";
    worldX=next;
    player.style.bottom=bottom+"px";

    document.querySelectorAll(".obstacle").forEach(o=>{
      const pr=player.getBoundingClientRect(), r=o.getBoundingClientRect();
      if(pr.right>r.left && pr.left<r.right){ showMath(); o.remove(); }
    });
  }
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mattepromenaden</title>

<style>
*{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#1e3a8a;
  overflow:hidden;
}

/* ===== SPEL ===== */
#game{
  position:relative;
  height:60vh;
  background:linear-gradient(#60a5fa,#86efac);
  overflow:hidden;
}
#world{
  position:absolute;
  bottom:0;
  left:0;
  width:6500px;
  height:100%;
}
.ground{
  position:absolute;
  bottom:0;
  width:6500px;
  height:80px;
  background:#22c55e;
}

/* ===== MILJ√ñ ===== */
.sun{
  position:absolute;
  top:20px; right:40px;
  width:80px; height:80px;
  background:#fde047;
  border-radius:50%;
}

/* ===== BERG ===== */
.hill{
  position:absolute;
  bottom:80px;
  width:180px;
  height:80px;
  background:#4b5563;
  border-radius:90px 90px 0 0;
}

/* ===== HINDER ===== */
.hedgehog{
  position:absolute;
  bottom:80px;
  width:38px;
  height:22px;
  background:#92400e;
  border-radius:12px;
}
.hedgehog::before{
  content:"";
  position:absolute;
  top:-10px;
  left:-2px;
  width:42px;
  height:14px;
  background:#78350f;
  clip-path:polygon(
    0% 100%,10% 0%,20% 100%,30% 0%,40% 100%,
    50% 0%,60% 100%,70% 0%,80% 100%,90% 0%,100% 100%
  );
}

.cube{
  position:absolute;
  bottom:80px;
  width:44px;
  height:44px;
  background:#7c3aed;
  border-radius:8px;
  color:white;
  font-size:1.8rem;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ===== M√ÖLFLAGGA ===== */
@keyframes wave{
  0%{transform:rotate(0deg)}
  50%{transform:rotate(6deg)}
  100%{transform:rotate(0deg)}
}
.flag{
  position:absolute;
  bottom:80px;
  left:5800px;
}
.flagpole{
  width:6px;
  height:120px;
  background:#334155;
}
.flagcloth{
  width:40px;
  height:24px;
  background:#ef4444;
  margin-left:6px;
  margin-top:10px;
  transform-origin:left center;
}
.flag.active .flagcloth{
  animation:wave .6s infinite;
}

/* ===== GUBBE ===== */
#player{
  position:absolute;
  left:45%;
  bottom:80px;
  width:40px;
}
.head{
  width:24px;
  height:24px;
  background:#fde68a;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto;
}
.body{
  width:20px;
  height:28px;
  background:#2563eb;
  border-radius:6px;
  margin:2px auto 0;
  position:relative;
}
.arm{
  position:absolute;
  top:8px;
  width:10px;
  height:4px;
  background:#fde68a;
}
.arm.left{ left:-10px; }
.arm.right{ right:-10px; }

.legs{
  display:flex;
  justify-content:space-between;
  width:30px;
  margin:0 auto;
}
.leg{
  width:12px;
  height:20px;
  background:#1e293b;
  border-radius:6px;
}
.walking .leg{
  animation:walk .25s alternate infinite;
}
@keyframes walk{
  from{transform:rotate(10deg)}
  to{transform:rotate(-10deg)}
}

/* ===== KONTROLLER ===== */
#controls{
  display:flex;
  justify-content:center;
  gap:30px;
  padding:12px;
  background:#0f172a;
}
button{
  font-size:1.8rem;
  padding:12px 18px;
  border-radius:14px;
  border:none;
  background:#1e3a8a;
  color:white;
  user-select:none;
}

/* ===== MATTE ===== */
#mathOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}
.gridWrapper{
  background:white;
  padding:16px;
  border:3px solid #0f172a;
}
.grid{
  display:grid;
  grid-template-columns:56px 56px 56px;
  grid-template-rows:56px 56px 56px 56px;
}
.cell{
  border:2px solid black;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2rem;
}
.row3{ border-bottom:6px solid black !important; }
.ones{ color:#16a34a; font-weight:700; }
.tens{ color:#2563eb; font-weight:600; }
input{
  width:100%;
  height:100%;
  border:none;
  font-size:2rem;
  text-align:center;
  background:transparent;
}

/* ===== FYRVERKERI ===== */
.firework{
  position:fixed;
  left:50%; top:40%;
  pointer-events:none;
}
.spark{
  position:absolute;
  width:8px; height:8px;
  border-radius:50%;
  animation:explode .9s forwards;
}
@keyframes explode{
  to{
    transform:translate(var(--x),var(--y));
    opacity:0;
  }
}
</style>
</head>

<body>

<div id="game">
  <div id="world">
    <div class="ground"></div>
    <div class="sun"></div>

    <div class="hill platform" style="left:900px"></div>
    <div class="hill platform" style="left:2600px"></div>

    <div class="hedgehog obstacle" style="left:700px"></div>
    <div class="cube obstacle" style="left:1300px">?</div>
    <div class="hedgehog obstacle" style="left:2100px"></div>
    <div class="cube obstacle" style="left:3200px">?</div>
    <div class="hedgehog obstacle" style="left:4200px"></div>

    <!-- M√ÖL -->
    <div class="flag" id="flag">
      <div class="flagpole"></div>
      <div class="flagcloth"></div>
    </div>
  </div>

  <div id="player">
    <div class="head">üôÇ</div>
    <div class="body">
      <div class="arm left"></div>
      <div class="arm right"></div>
    </div>
    <div class="legs">
      <div class="leg"></div><div class="leg"></div>
    </div>
  </div>
</div>

<div id="controls">
  <button id="leftBtn">‚¨ÖÔ∏è</button>
  <button id="jumpBtn">‚¨ÜÔ∏è</button>
  <button id="rightBtn">‚û°Ô∏è</button>
</div>

<div id="mathOverlay">
  <div class="gridWrapper">
    <div class="grid" id="grid"></div>
    <div style="text-align:center;margin-top:10px">
      <button onclick="check()">Klar</button>
    </div>
  </div>
</div>

<audio id="bgMusic" src="Music.mp3" loop></audio>
<audio id="successSound" src="Correct.mp3"></audio>
<audio id="jumpSound" src="Jump.mp3"></audio>
<audio id="finishSound" src="Finish.mp3"></audio>

<script>
/* ===== LJUDSTART ===== */
let audioStarted=false;
function startAudio(){
  if(!audioStarted){
    bgMusic.volume=0.3;
    bgMusic.play().catch(()=>{});
    audioStarted=true;
  }
}

/* ===== MATTE ===== */
const tasks=["39+15","63+28","58+34","49+32","27+46"];
let taskIndex=0, correct=0, paused=false, finished=false;

/* ===== SPEL ===== */
let worldX=0,vy=0,onGround=true,left=false,right=false;
const speed=3,gravity=0.6;

leftBtn.onpointerdown=()=>{left=true;player.classList.add("walking");startAudio();};
leftBtn.onpointerup=()=>{left=false;player.classList.remove("walking");};
rightBtn.onpointerdown=()=>{right=true;player.classList.add("walking");startAudio();};
rightBtn.onpointerup=()=>{right=false;player.classList.remove("walking");};

jumpBtn.onpointerdown=()=>{
  startAudio();
  if(onGround){
    jumpSound.play().catch(()=>{});
    vy=11; onGround=false;
  }
};

function showMath(){
  paused=true;
  grid.innerHTML="";
  const [a,b]=tasks[taskIndex].split("+").map(Number);
  correct=a+b;

  const aS=String(a).padStart(2,"0");
  const bS=String(b).padStart(2,"0");

  const cells=[
    "i","i","i",
    "",aS[0],aS[1],
    "+",bS[0],bS[1],
    "i","i","i"
  ];

  cells.forEach((v,i)=>{
    const c=document.createElement("div");
    c.className="cell";
    if(i>=6&&i<=8)c.classList.add("row3");
    if(v==="i"){
      const inp=document.createElement("input");
      inp.inputMode="numeric";
      c.appendChild(inp);
    }else{
      c.textContent=v;
      if(i%3===2)c.classList.add("ones");
      if(i%3===1)c.classList.add("tens");
    }
    grid.appendChild(c);
  });

  mathOverlay.style.display="flex";
}

function check(){
  const ans=[...grid.querySelectorAll(".cell")].slice(9,12)
    .map(c=>c.querySelector("input").value||"").join("");
  if(parseInt(ans)===correct){
    successSound.play().catch(()=>{});
    firework();
    mathOverlay.style.display="none";
    paused=false;
    taskIndex++;
    if(taskIndex>=tasks.length){
      finished=true;
    }
  }
}

function firework(){
  const fw=document.createElement("div");
  fw.className="firework";
  document.body.appendChild(fw);
  for(let i=0;i<10;i++){
    const s=document.createElement("div");
    s.className="spark";
    s.style.background=["#22c55e","#2563eb","#facc15"][i%3];
    s.style.setProperty("--x",(Math.random()*120-60)+"px");
    s.style.setProperty("--y",(Math.random()*-120)+"px");
    fw.appendChild(s);
  }
  setTimeout(()=>fw.remove(),900);
}

function loop(){
  if(!paused){
    let next=worldX;
    if(right)next-=speed;
    if(left)next+=speed;

    vy-=gravity;
    let bottom=parseFloat(player.style.bottom||80)+vy;
    onGround=false;

    document.querySelectorAll(".platform").forEach(p=>{
      const pr=player.getBoundingClientRect();
      const r=p.getBoundingClientRect();
      if(pr.bottom<=r.top+10 && pr.right>r.left && pr.left<r.right && vy<=0){
        bottom = r.top - game.getBoundingClientRect().bottom;
        vy=0; onGround=true;
      }
    });

    if(bottom<=80){ bottom=80; vy=0; onGround=true; }

    world.style.left=next+"px";
    worldX=next;
    player.style.bottom=bottom+"px";

    /* M√ÖL */
    if(finished){
      const pr=player.getBoundingClientRect();
      const fr=document.getElementById("flag").getBoundingClientRect();
      if(pr.right>fr.left){
        paused=true;
        document.getElementById("flag").classList.add("active");
        bgMusic.volume=0.1;
        finishSound.play().catch(()=>{});
      }
    }

    document.querySelectorAll(".obstacle").forEach(o=>{
      const pr=player.getBoundingClientRect(), r=o.getBoundingClientRect();
      if(pr.right>r.left && pr.left<r.right && !paused){
        showMath();
        o.remove();
      }
    });
  }
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>